<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:ext="http://www.liquibase.org/xml/ns/dbchangelog-ext"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog-ext
   http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-ext.xsd
   http://www.liquibase.org/xml/ns/dbchangelog
   http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.4.xsd">

    <changeSet  author="gleb"  id="TAG-STATE-0.65.0">
        <tagDatabase  tag="0.66.3"/>
    </changeSet>

    <changeSet author="gleb" id="ADD-COLUMN-books.update_date">
        <addColumn tableName="books">
            <column name="update_date"
                    type="TIMESTAMP WITHOUT TIME ZONE"/>
        </addColumn>
    </changeSet>

    <changeSet author="gleb" id="MIGRATE-books.last_update_date-TO-books.update_date" >
        <sql>
            update books b
            set update_date = s.dt
            from (
                select
                    book_id,
                    last_update_date AT TIME ZONE 'UTC' as dt
                from
                    books
            ) s
            where b.book_id = s.book_id
            ;
        </sql>
        <rollback/>
    </changeSet>

    <changeSet author="gleb" id="ADD-NOT-NULL-books.update_date">
        <addNotNullConstraint
                tableName="books"
                columnName="update_date"
        />
    </changeSet>

    <changeSet author="gleb" id="DROP-NOT-NULL-CONSTRAINT-books.last_update_date" >
        <dropNotNullConstraint
                tableName="books"
                columnName="last_update_date"
        />
    </changeSet>

</databaseChangeLog>